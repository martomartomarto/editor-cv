<script>
document.addEventListener('DOMContentLoaded', function() {
    const translations = {
        en: {
            ui: { dateOfBirth: "Date of birth", nationality: "Nationality", profile: "Executive Summary", employmentHistory: "Professional Experience", education: "Education", skills: "Skills" },
            sampleData: { nombre: 'Martín Mastrogiacomo', ubicacion: 'Buenos Aires, Argentina', email: 'martomastrogiacomo@gmail.com', telefono: '+549 11 5 890 7085', linkedin: 'https://www.linkedin.com/in/martin-mastrogiacomo/', fechaNacimiento: '09/02/1995', nacionalidad: 'Argentinean, Italian', perfil: `Results-driven Growth & Business Intelligence Specialist with a strong background in data analytics, digital marketing, and automation. Proven ability to leverage SQL, Tableau, Amazon Redshift, and A/B testing to drive growth, optimize user journeys, and enhance data-driven decision-making. Passionate about bridging the gap between marketing strategy and business intelligence to scale operations and maximize impact.`, experienciaList: [ {puesto:"Growth Lead, Ontop", fecha:"Apr 2025 — Present",descripcion:"Lead the overall growth strategy, integrating paid media, organic, and referral channels.\nDesign and optimize multi-channel marketing campaigns (Google Ads, LinkedIn Ads, Braze).\nAnalyze data (SQL, Tableau, Salesforce) to refine the ICP, segment audiences, and identify growth opportunities."}, {puesto:"Growth & BI Specialist, Ontop", fecha:"Apr 2023 — Apr 2025",descripcion:"Increased conversion rates by 10% through A/B testing on landing pages.\nBoosted retention rates by 15% by optimizing lifecycle marketing strategies.\nDeveloped predictive cohort analysis that reduced churn by 15%.\nAutomated Tableau dashboards, reducing decision-making time by 30%."}, {puesto:"BI Specialist, Flippin", fecha:"May 2022 — Dec 2022",descripcion:"Optimized investment decisions for real estate clients, increasing portfolio ROI by 12%.\nImplemented web scraping solutions that accelerated market trend analysis by 40%.\nDeveloped WhatsApp chatbots that improved lead generation by 35%."}, {puesto:"Managment Consultant, Accenture", fecha:"Aug 2021 — Apr 2022",descripcion:"Led Salesforce CPQ software implementation for enterprise clients.\nProvided pricing and sales strategy consulting, optimizing revenue operations."} ], educacionList: [ {titulo:"Data Analytics",institucion:"Digital House, Buenos Aires",fecha:"Apr 2020 — Sep 2020"}, {titulo:"Business Administration Degree",institucion:"Universidad de San Andres, Buenos Aires",fecha:"Jul 2013 — Jul 2017"}, {titulo:"Bilingual Bachelor",institucion:"Saint Gregory's College, Buenos Aires",fecha:"Feb 2010 — Dec 2012"} ], habilidadesList: [ {categoria:"Growth Strategy & Analytics",lista:"A/B Testing, Funnel Optimization, Cohort Analysis"}, {categoria:"Business Intelligence",lista:"Tableau, Power BI, Looker/Data Studio"}, {categoria:"Databases & SQL",lista:"Amazon Redshift, MySQL"}, {categoria:"Automation & Scripting",lista:"Google Sheets Scripts, Alteryx"} ] }
        },
        es: {
            ui: { dateOfBirth: "Fecha de Nacimiento", nationality: "Nacionalidad", profile: "Perfil", employmentHistory: "Experiencia Laboral", education: "Educación", skills: "Habilidades" },
            sampleData: { nombre: 'Martín Mastrogiacomo', ubicacion: 'Buenos Aires, Argentina', email: 'martomastrogiacomo@gmail.com', telefono: '+549 11 5 890 7085', linkedin: 'https://www.linkedin.com/in/martin-mastrogiacomo/', fechaNacimiento: '09/02/1995', nacionalidad: 'Argentina, Italiana', perfil: `Especialista en Growth & Business Intelligence orientado a resultados, con una sólida experiencia en análisis de datos, marketing digital y automatización. Capacidad demostrada para utilizar SQL, Tableau, Amazon Redshift y A/B testing para impulsar el crecimiento, optimizar el recorrido del usuario y mejorar la toma de decisiones. Apasionado por unir la estrategia de marketing y la inteligencia de negocio para escalar operaciones y maximizar el impacto.`, experienciaList: [ {puesto:"Growth Lead, Ontop", fecha:"Abr 2025 — Actualidad",descripcion:"Lidero la estrategia general de crecimiento, integrando canales de pago, orgánicos y de referidos.\nDiseño y optimizo campañas de marketing multicanal (Google Ads, LinkedIn Ads, Braze).\nAnalizo datos (SQL, Tableau, Salesforce) para refinar el ICP, segmentar audiencias e identificar oportunidades de crecimiento."}, {puesto:"Growth & BI Specialist, Ontop", fecha:"Abr 2023 — Abr 2025",descripcion:"Aumenté las tasas de conversión en un 10% mediante A/B testing en landing pages.\nIncrementé las tasas de retención en un 15% optimizando estrategias de marketing de ciclo de vida.\nDesarrollé análisis de cohortes predictivos que redujeron el churn en un 15%.\nAutomaticé dashboards en Tableau, reduciendo el tiempo de toma de decisiones en un 30%."}, {puesto:"BI Specialist, Flippin", fecha:"May 2022 — Dic 2022",descripcion:"Optimicé decisiones de inversión para clientes inmobiliarios, aumentando el ROI del portafolio en un 12%.\nImplementé soluciones de web scraping que aceleraron el análisis de mercado en un 40%.\nDesarrollé chatbots de WhatsApp que mejoraron la generación de leads en un 35%."}, {puesto:"Consultor de Gestión, Accenture", fecha:"Ago 2021 — Abr 2022",descripcion:"Lideré la implementación del software Salesforce CPQ para clientes corporativos.\nProporcioné consultoría en precios y estrategia de ventas, optimizando las operaciones de ingresos."} ], educacionList: [ {titulo:"Data Analytics",institucion:"Digital House, Buenos Aires",fecha:"Apr 2020 — Sep 2020"}, {titulo:"Licenciatura en Administración de Empresas",institucion:"Universidad de San Andres, Buenos Aires",fecha:"Jul 2013 — Jul 2017"}, {titulo:"Bachiller Bilingüe",institucion:"Saint Gregory's College, Buenos Aires",fecha:"Feb 2010 — Dec 2012"} ], habilidadesList: [ {categoria:"Estrategia de Crecimiento & Analítica",lista:"A/B Testing, Optimización de Funnels, Análisis de Cohortes"}, {categoria:"Inteligencia de Negocio",lista:"Tableau, Power BI, Looker/Data Studio"}, {categoria:"Bases de Datos & SQL",lista:"Amazon Redshift, MySQL"}, {categoria:"Automatización & Scripting",lista:"Google Sheets Scripts, Alteryx"} ] }
        }
    };

    let currentLang = 'en'; // Variable global para saber el idioma actual
    const fields=["nombre","ubicacion","email","telefono","linkedin","fechaNacimiento","nacionalidad","perfil"];
    const lists=["experiencia","educacion","habilidades"];

    // --- LÓGICA DE ANIMACIÓN (sin cambios) ---
    const headImageSrc = 'Subject.png';
    const heads = []; const numHeads = 15; const headSize = 90; const minSpeed = 0.5; const maxSpeed = 1.5;
    let animationFrameId;
    function initAnimation(){const c=document.getElementById("background-animation-container");if(!c)return;c.innerHTML="",heads.length=0;for(let i=0;i<numHeads;i++){const h=document.createElement("img");h.src=headImageSrc,h.className="rolling-head",h.style.width=`${headSize}px`,h.style.height="auto",c.appendChild(h),heads.push({element:h,x:Math.random()*window.innerWidth,y:Math.random()*window.innerHeight,vx:(Math.random()*(maxSpeed-minSpeed)+minSpeed)*(Math.random()<.5?1:-1),vy:(Math.random()*(maxSpeed-minSpeed)+minSpeed)*(Math.random()<.5?1:-1),rotation:360*Math.random(),rotationSpeed:2*(Math.random()-.5)})}}
    function animate(){heads.forEach(h=>{h.x+=h.vx,h.y+=h.vy,h.rotation+=h.rotationSpeed,(h.x<0||h.x>window.innerWidth-headSize)&&(h.vx*=-1),(h.y<0||h.y>window.innerHeight-headSize)&&(h.vy*=-1),h.element.style.transform=`translate(${h.x}px, ${h.y}px) rotate(${h.rotation}deg)`}),animationFrameId=requestAnimationFrame(animate)}

    // --- FUNCIONES DE MANIPULACIÓN DEL DOM (con pequeños ajustes) ---
    
    // ** MODIFICADO: Guarda los datos para un idioma específico **
    const saveData = (lang) => {
        fields.forEach(field => {
            const input = document.getElementById(field);
            if (input) localStorage.setItem(`${lang}_${field}`, input.value);
        });
        lists.forEach(listName => {
            const items = Array.from(document.querySelectorAll(`#${listName}-list .item-form`)).map(form => {
                const item = {};
                form.querySelectorAll("input, textarea").forEach(input => {
                    item[input.dataset.key] = input.value;
                });
                return item;
            });
            localStorage.setItem(`${lang}_${listName}List`, JSON.stringify(items));
        });
        const photoSrc = document.getElementById("preview-photo").src;
        if (photoSrc && !photoSrc.startsWith("https://placehold.co")) {
            localStorage.setItem("userPhoto", photoSrc); // La foto es global
        }
    };

    const updatePreview=()=>{document.getElementById("preview-nombre").textContent=document.getElementById("nombre").value;const e=[document.getElementById("ubicacion").value,document.getElementById("telefono").value,document.getElementById("email").value];document.getElementById("preview-header-contact").textContent=e.filter(Boolean).join("  ·  ");const t=document.getElementById("linkedin").value,a=document.getElementById("preview-linkedin-container"),n='<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="currentColor" class="bi bi-linkedin" viewBox="0 0 16 16"><path d="M0 1.146C0 .513.526 0 1.175 0h13.65C15.474 0 16 .513 16 1.146v13.708c0 .633-.526 1.146-1.175 1.146H1.175C.526 16 0 15.487 0 14.854V1.146zm4.943 12.248V6.169H2.542v7.225h2.401zm-1.2-8.212c.837 0 1.358-.554 1.358-1.248-.015-.709-.52-1.248-1.342-1.248-.822 0-1.359.54-1.359 1.248 0 .694.521 1.248 1.327 1.248h.016zm4.908 8.212V9.359c0-.216.016-.432.08-.586.173-.431.568-.878 1.232-.878.869 0 1.216.662 1.216 1.634v3.865h2.401V9.25c0-2.22-1.184-3.252-2.764-3.252-1.325 0-1.845.723-2.165 1.193v.025h-.016a5.54 5.54 0 0 1 .016-.025V6.169h-2.4c.03.678 0 7.225 0 7.225h2.4z"/></svg>';t?a.innerHTML=`<a href="${t}" target="_blank" rel="noopener noreferrer" class="text-gray-600 hover:text-blue-700 hover:underline flex items-center gap-1.5" style="font-size: 8.5pt;">${n} <span>${t.replace("https://www.","").replace("http://www.","").replace(/\/$/,"")}</span></a>`:a.innerHTML="",document.getElementById("preview-fechaNacimiento").textContent=document.getElementById("fechaNacimiento").value,document.getElementById("preview-nacionalidad").textContent=document.getElementById("nacionalidad").value,document.getElementById("preview-perfil").textContent=document.getElementById("perfil").value;
        lists.forEach(listName => {
            const previewList = document.getElementById(`preview-${listName}-list`);
            previewList.innerHTML = "";
            const itemsData = JSON.parse(localStorage.getItem(`${currentLang}_${listName}List`)) || [];
            itemsData.forEach(itemData => {
                const itemDiv = document.createElement("div");
                updateListPreview(listName, itemDiv, itemData);
                previewList.appendChild(itemDiv);
            });
        });
    };
    
    const addToList = (listName, data = {}) => {
        const listContainer = document.getElementById(`${listName}-list`);
        const itemId = `${listName}-${Date.now()}-${Math.random()}`;
        const formDiv = document.createElement('div');
        formDiv.className = 'item-form p-3 border border-gray-200 rounded-md relative pr-10';
        formDiv.id = `form-${itemId}`;
        let formContent = '';
        if (listName === 'experiencia') { formContent = `<input type="text" data-key="puesto" placeholder="Position, Company" class="w-full p-1 mb-2 border rounded-md" value="${data.puesto || ''}"><input type="text" data-key="fecha" placeholder="Date" class="w-full p-1 mb-2 border rounded-md" value="${data.fecha || ''}"><textarea data-key="descripcion" placeholder="Description" class="w-full p-1 border rounded-md h-24">${data.descripcion || ''}</textarea>`; } 
        else if (listName === 'educacion') { formContent = `<input type="text" data-key="titulo" placeholder="Degree / Title" class="w-full p-1 mb-2 border rounded-md" value="${data.titulo || ''}"><input type="text" data-key="institucion" placeholder="Institution & Location" class="w-full p-1 mb-2 border rounded-md" value="${data.institucion || ''}"><input type="text" data-key="fecha" placeholder="Date" class="w-full p-1 border rounded-md" value="${data.fecha || ''}">`; } 
        else if (listName === 'habilidades') { formContent = `<input type="text" data-key="categoria" placeholder="Category" class="w-full p-1 mb-2 border rounded-md" value="${data.categoria || ''}"><textarea data-key="lista" placeholder="Skills" class="w-full p-1 border rounded-md h-16">${data.lista || ''}</textarea>`; }
        const controls = `<div class="item-controls"><button onclick="moveItemUp('${itemId}')" class="control-btn move-btn" title="Move up">&uarr;</button><button onclick="moveItemDown('${itemId}')" class="control-btn move-btn" title="Move down">&darr;</button><button onclick="deleteItem('${itemId}')" class="control-btn delete-btn" title="Delete">&times;</button></div>`;
        formDiv.innerHTML = formContent + controls;
        listContainer.prepend(formDiv); 
        formDiv.querySelectorAll('input, textarea').forEach(input => {
            input.addEventListener('input', () => { saveData(currentLang); updatePreview(); });
        });
    };
    
    window.deleteItem=id=>{document.getElementById(`form-${id}`)?.remove(),saveData(currentLang),updatePreview()};
    window.moveItemUp=id=>{const item=document.getElementById(`form-${id}`);item?.previousElementSibling&&item.parentNode.insertBefore(item,item.previousElementSibling),saveData(currentLang),updatePreview()};
    window.moveItemDown=id=>{const item=document.getElementById(`form-${id}`);item?.nextElementSibling&&item.parentNode.insertBefore(item.nextElementSibling,item),saveData(currentLang),updatePreview()};

    const updateListPreview=(e,t,a)=>{if("experiencia"===e)t.className="item-block",t.innerHTML=`<div class="item-header"><h3>${a.puesto||""}</h3><p class="date">${a.fecha||""}</p></div><ul>${(a.descripcion||"").split("\n").map(e=>e.trim()?`<li>${e.trim()}</li>`:"").join("")}</ul>`;else if("educacion"===e)t.className="item-block",t.innerHTML=`<div class="item-header"><h3>${a.titulo||""}</h3><p class="date">${a.fecha||""}</p></div><p class="education-institution">${a.institucion||""}</p>`;else if("habilidades"===e){t.className="skill-item",t.innerHTML=`<div><h3>${a.categoria||""}</h3><p>${a.lista||""}</p></div>`}};

    const applyTranslations = lang => {
        const uiTranslations = translations[lang].ui;
        document.querySelectorAll("[data-translate]").forEach(elem => {
            const key = elem.getAttribute("data-translate");
            if (uiTranslations[key]) elem.textContent = uiTranslations[key];
        });
    };
    
    // ** NUEVO: Carga los datos para un idioma, usando localStorage o sampleData **
    const loadDataForLanguage = (lang) => {
        // Limpia los formularios de las listas actuales
        lists.forEach(listName => {
            document.getElementById(`${listName}-list`).innerHTML = '';
        });

        // Carga campos de texto
        fields.forEach(field => {
            const savedValue = localStorage.getItem(`${lang}_${field}`);
            const input = document.getElementById(field);
            if (savedValue !== null) {
                input.value = savedValue;
            } else {
                input.value = translations[lang].sampleData[field] || '';
            }
        });
        
        // Carga las listas
        lists.forEach(listName => {
            const listKey = `${listName}List`;
            const savedList = localStorage.getItem(`${lang}_${listKey}`);
            let itemsToLoad = [];
            if (savedList) {
                itemsToLoad = JSON.parse(savedList);
            } else {
                itemsToLoad = translations[lang].sampleData[listKey] || [];
            }
            // Cargamos en orden inverso para que al usar prepend() queden en el orden original
            itemsToLoad.slice().reverse().forEach(item => addToList(listName, item));
        });

        // Guarda esta data (sea de localStorage o sample) para asegurar consistencia
        saveData(lang);
        updatePreview();
    };

    const handleLanguageChange = (newLang) => {
        const oldLang = currentLang;
        if (oldLang === newLang) return; // No hacer nada si el idioma no cambió

        // 1. Guardar los datos del idioma que estamos dejando
        saveData(oldLang);

        // 2. Actualizar el idioma actual
        currentLang = newLang;

        // 3. Cargar los datos para el nuevo idioma
        loadDataForLanguage(newLang);

        // 4. Aplicar las traducciones de la UI
        applyTranslations(newLang);
    };

    const initializeApp = () => {
        // Conectar eventos de los botones de "añadir"
        lists.forEach(listName => {
            const addButton = document.getElementById(`add-${listName}`);
            if(addButton) addButton.addEventListener("click", () => { addToList(listName); saveData(currentLang); updatePreview(); });
        });
        
        // Conectar eventos de los inputs de texto
        fields.forEach(field => {
            const input = document.getElementById(field);
            if(input) input.addEventListener("input", () => { saveData(currentLang); updatePreview(); });
        });

        // Evento de carga de foto
        document.getElementById("photo-upload").addEventListener("change", e => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = event => {
                    document.getElementById("preview-photo").src = event.target.result;
                    localStorage.setItem("userPhoto", event.target.result); // Guardar foto
                };
                reader.readAsDataURL(file);
            }
        });

        // Evento del botón de descarga
        document.getElementById("download-image").addEventListener("click",()=>{const e=document.getElementById("cv-preview-container"),t=document.getElementById("download-image");t.textContent="Generating...",t.disabled=!0,e.classList.add("export-mode"),html2canvas(e,{scale:3,useCORS:!0,logging:!1,windowWidth:e.scrollWidth,windowHeight:e.scrollHeight}).then(a=>{e.classList.remove("export-mode");const n=document.createElement("a");n.download=`cv-martin-mastrogiacomo-${document.getElementById("language-selector").value}.png`,n.href=a.toDataURL("image/png"),n.click(),t.textContent="Download Image",t.disabled=!1}).catch(a=>{console.error("Error generating image:",a),e.classList.remove("export-mode"),t.textContent="Download Image",t.disabled=!1})});

        // ** LÓGICA DE INICIALIZACIÓN Y CAMBIO DE IDIOMA **
        const langSelector = document.getElementById("language-selector");
        langSelector.addEventListener("change", (e) => handleLanguageChange(e.target.value));
        
        // Cargar foto global al inicio
        const photoSrc = localStorage.getItem("userPhoto");
        document.getElementById("preview-photo").src = photoSrc || 'Subject.png';

        // Cargar datos del idioma inicial
        loadDataForLanguage(currentLang);
        applyTranslations(currentLang);
        
        // Iniciar animación
        if (animationFrameId) cancelAnimationFrame(animationFrameId);
        initAnimation();
        animate();
    };

    initializeApp();
});
</script>
