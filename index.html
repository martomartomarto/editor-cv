<script>
document.addEventListener('DOMContentLoaded', function() {
    const translations = {
        en: {
            ui: { dateOfBirth: "Date of birth", nationality: "Nationality", profile: "Executive Summary", employmentHistory: "Professional Experience", education: "Education", skills: "Skills" },
            sampleData: { nombre: 'Martín Mastrogiacomo', ubicacion: 'Buenos Aires, Argentina', email: 'martomastrogiacomo@gmail.com', telefono: '+549 11 5 890 7085', linkedin: 'https://www.linkedin.com/in/martin-mastrogiacomo/', fechaNacimiento: '09/02/1995', nacionalidad: 'Argentinean, Italian', perfil: `Results-driven Growth & Business Intelligence Specialist...`, experienciaList: [ {puesto:"Growth Lead, Ontop", fecha:"Apr 2025 — Present",descripcion:"Lead the overall growth strategy..."}, {puesto:"Growth & BI Specialist, Ontop", fecha:"Apr 2023 — Apr 2025",descripcion:"Increased conversion rates by 10%..."}, {puesto:"BI Specialist, Flippin", fecha:"May 2022 — Dec 2022",descripcion:"Optimized investment decisions..."}, {puesto:"Managment Consultant, Accenture", fecha:"Aug 2021 — Apr 2022",descripcion:"Led Salesforce CPQ software implementation..."} ], educacionList: [ {titulo:"Data Analytics",institucion:"Digital House, Buenos Aires",fecha:"Apr 2020 — Sep 2020"}, {titulo:"Business Administration Degree",institucion:"Universidad de San Andres, Buenos Aires",fecha:"Jul 2013 — Jul 2017"}, {titulo:"Bilingual Bachelor",institucion:"Saint Gregory's College, Buenos Aires",fecha:"Feb 2010 — Dec 2012"} ], habilidadesList: [ {categoria:"Growth Strategy & Analytics",lista:"A/B Testing, Funnel Optimization, Cohort Analysis"}, {categoria:"Business Intelligence",lista:"Tableau, Power BI, Looker/Data Studio"}, {categoria:"Databases & SQL",lista:"Amazon Redshift, MySQL"}, {categoria:"Automation & Scripting",lista:"Google Sheets Scripts, Alteryx"} ] }
        },
        es: {
            ui: { dateOfBirth: "Fecha de Nacimiento", nationality: "Nacionalidad", profile: "Perfil", employmentHistory: "Experiencia Laboral", education: "Educación", skills: "Habilidades" },
            sampleData: { nombre: 'Martín Mastrogiacomo', ubicacion: 'Buenos Aires, Argentina', email: 'martomastrogiacomo@gmail.com', telefono: '+549 11 5 890 7085', linkedin: 'https://www.linkedin.com/in/martin-mastrogiacomo/', fechaNacimiento: '09/02/1995', nacionalidad: 'Argentina, Italiana', perfil: `Especialista en Growth & Business Intelligence orientado a resultados...`, experienciaList: [ {puesto:"Growth Lead, Ontop", fecha:"Abr 2025 — Actualidad",descripcion:"Lidero la estrategia general de crecimiento..."}, {puesto:"Growth & BI Specialist, Ontop", fecha:"Abr 2023 — Abr 2025",descripcion:"Aumenté las tasas de conversión en un 10%..."}, {puesto:"BI Specialist, Flippin", fecha:"May 2022 — Dic 2022",descripcion:"Optimicé decisiones de inversión..."}, {puesto:"Consultor de Gestión, Accenture", fecha:"Ago 2021 — Abr 2022",descripcion:"Lideré la implementación del software Salesforce CPQ..."} ], educacionList: [ {titulo:"Data Analytics",institucion:"Digital House, Buenos Aires",fecha:"Abr 2020 — Sep 2020"}, {titulo:"Licenciatura en Administración de Empresas",institucion:"Universidad de San Andres, Buenos Aires",fecha:"Jul 2013 — Jul 2017"}, {titulo:"Bachiller Bilingüe",institucion:"Saint Gregory's College, Buenos Aires",fecha:"Feb 2010 — Dec 2012"} ], habilidadesList: [ {categoria:"Estrategia de Crecimiento & Analítica",lista:"A/B Testing, Optimización de Funnels, Análisis de Cohortes"}, {categoria:"Inteligencia de Negocio",lista:"Tableau, Power BI, Looker/Data Studio"}, {categoria:"Bases de Datos & SQL",lista:"Amazon Redshift, MySQL"}, {categoria:"Automatización & Scripting",lista:"Google Sheets Scripts, Alteryx"} ] }
        }
    };

    const headImageSrc = 'Subject.png';
    const numHeads = 15;
    const headSize = 90;
    const minSpeed = 0.5;
    const maxSpeed = 1.5;
    const heads = [];
    let animationFrameId;

    function initAnimation(){const container=document.getElementById("background-animation-container");if(!container)return;container.innerHTML="",heads.length=0;for(let e=0;e<numHeads;e++){const t=document.createElement("img");t.src=headImageSrc,t.className="rolling-head",t.style.width=`${headSize}px`,t.style.height="auto",container.appendChild(t),heads.push({element:t,x:Math.random()*window.innerWidth,y:Math.random()*window.innerHeight,vx:(Math.random()*(maxSpeed-minSpeed)+minSpeed)*(Math.random()<.5?1:-1),vy:(Math.random()*(maxSpeed-minSpeed)+minSpeed)*(Math.random()<.5?1:-1),rotation:360*Math.random(),rotationSpeed:2*(Math.random()-.5)})}}
    function animate(){heads.forEach(e=>{e.x+=e.vx,e.y+=e.vy,e.rotation+=e.rotationSpeed,(e.x<0||e.x>window.innerWidth-headSize)&&(e.vx*=-1),(e.y<0||e.y>window.innerHeight-headSize)&&(e.vy*=-1),e.element.style.transform=`translate(${e.x}px, ${e.y}px) rotate(${e.rotation}deg)`}),animationFrameId=requestAnimationFrame(animate)}
    
    const fields=["nombre","ubicacion","email","telefono","linkedin","fechaNacimiento","nacionalidad","perfil"],lists=["experiencia","educacion","habilidades"];
    
    window.deleteItem=e=>{document.getElementById(`form-${e}`)?.remove(),saveData(),updatePreview()},window.moveItemUp=e=>{const t=document.getElementById(`form-${e}`);t?.previousElementSibling&&t.parentNode.insertBefore(t,t.previousElementSibling),saveData(),updatePreview()},window.moveItemDown=e=>{const t=document.getElementById(`form-${e}`);t?.nextElementSibling&&t.parentNode.insertBefore(t.nextElementSibling,t),saveData(),updatePreview()};
    
    const saveData=()=>{
        // Esta bandera nos ayudará a saber que el usuario ya guardó datos.
        localStorage.setItem('cvEditorHasData', 'true'); 
        fields.forEach(e=>{const t=document.getElementById(e);t&&localStorage.setItem(e,t.value)}),lists.forEach(e=>{const t=Array.from(document.querySelectorAll(`#${e}-list .item-form`)).map(e=>{const t={};return e.querySelectorAll("input, textarea").forEach(e=>{t[e.dataset.key]=e.value}),t});localStorage.setItem(`${e}List`,JSON.stringify(t))});const e=document.getElementById("preview-photo").src;e&&!e.startsWith("https://placehold.co")&&localStorage.setItem("userPhoto",e)
    };
    
    const updatePreview=()=>{document.getElementById("preview-nombre").textContent=document.getElementById("nombre").value;const e=[document.getElementById("ubicacion").value,document.getElementById("telefono").value,document.getElementById("email").value];document.getElementById("preview-header-contact").textContent=e.filter(Boolean).join("  ·  ");const t=document.getElementById("linkedin").value,a=document.getElementById("preview-linkedin-container"),n='<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="currentColor" class="bi bi-linkedin" viewBox="0 0 16 16"><path d="M0 1.146C0 .513.526 0 1.175 0h13.65C15.474 0 16 .513 16 1.146v13.708c0 .633-.526 1.146-1.175 1.146H1.175C.526 16 0 15.487 0 14.854V1.146zm4.943 12.248V6.169H2.542v7.225h2.401zm-1.2-8.212c.837 0 1.358-.554 1.358-1.248-.015-.709-.52-1.248-1.342-1.248-.822 0-1.359.54-1.359 1.248 0 .694.521 1.248 1.327 1.248h.016zm4.908 8.212V9.359c0-.216.016-.432.08-.586.173-.431.568-.878 1.232-.878.869 0 1.216.662 1.216 1.634v3.865h2.401V9.25c0-2.22-1.184-3.252-2.764-3.252-1.325 0-1.845.723-2.165 1.193v.025h-.016a5.54 5.54 0 0 1 .016-.025V6.169h-2.4c.03.678 0 7.225 0 7.225h2.4z"/></svg>';t?a.innerHTML=`<a href="${t}" target="_blank" rel="noopener noreferrer" class="text-gray-600 hover:text-blue-700 hover:underline flex items-center gap-1.5" style="font-size: 8.5pt;">${n} <span>${t.replace("https://www.","").replace("http://www.","").replace(/\/$/,"")}</span></a>`:a.innerHTML="",document.getElementById("preview-fechaNacimiento").textContent=document.getElementById("fechaNacimiento").value,document.getElementById("preview-nacionalidad").textContent=document.getElementById("nacionalidad").value,document.getElementById("preview-perfil").textContent=document.getElementById("perfil").value,lists.forEach(e=>{const t=document.getElementById(`preview-${e}-list`);t.innerHTML="";const a=JSON.parse(localStorage.getItem(`${e}List`))||[];a.forEach(a=>{const n=document.createElement("div");updateListPreview(e,n,a),t.appendChild(n)})})};
    
    const addToList = (listName, data = {}) => {
        const listContainer = document.getElementById(`${listName}-list`);
        const itemId = `${listName}-${Date.now()}-${Math.random()}`;
        const formDiv = document.createElement('div');
        formDiv.className = 'item-form p-3 border border-gray-200 rounded-md relative pr-10';
        formDiv.id = `form-${itemId}`;
        let formContent = '';
        if (listName === 'experiencia') { formContent = `<input type="text" data-key="puesto" placeholder="Position, Company" class="w-full p-1 mb-2 border rounded-md" value="${data.puesto || ''}"><input type="text" data-key="fecha" placeholder="Date" class="w-full p-1 mb-2 border rounded-md" value="${data.fecha || ''}"><textarea data-key="descripcion" placeholder="Description" class="w-full p-1 border rounded-md h-24">${data.descripcion || ''}</textarea>`; } 
        else if (listName === 'educacion') { formContent = `<input type="text" data-key="titulo" placeholder="Degree / Title" class="w-full p-1 mb-2 border rounded-md" value="${data.titulo || ''}"><input type="text" data-key="institucion" placeholder="Institution & Location" class="w-full p-1 mb-2 border rounded-md" value="${data.institucion || ''}"><input type="text" data-key="fecha" placeholder="Date" class="w-full p-1 border rounded-md" value="${data.fecha || ''}">`; } 
        else if (listName === 'habilidades') { formContent = `<input type="text" data-key="categoria" placeholder="Category" class="w-full p-1 mb-2 border rounded-md" value="${data.categoria || ''}"><textarea data-key="lista" placeholder="Skills" class="w-full p-1 border rounded-md h-16">${data.lista || ''}</textarea>`; }
        const controls = `<div class="item-controls"><button onclick="moveItemUp('${itemId}')" class="control-btn move-btn" title="Move up">&uarr;</button><button onclick="moveItemDown('${itemId}')" class="control-btn move-btn" title="Move down">&darr;</button><button onclick="deleteItem('${itemId}')" class="control-btn delete-btn" title="Delete">&times;</button></div>`;
        formDiv.innerHTML = formContent + controls;
        listContainer.appendChild(formDiv); // Usamos appendChild para mantener el orden al cargar
        formDiv.querySelectorAll('input, textarea').forEach(input => {
            input.addEventListener('input', () => { saveData(); updatePreview(); });
        });
    };

    const updateListPreview=(e,t,a)=>{if("experiencia"===e)t.className="item-block",t.innerHTML=`<div class="item-header"><h3>${a.puesto||""}</h3><p class="date">${a.fecha||""}</p></div><ul>${(a.descripcion||"").split("\n").map(e=>e.trim()?`<li>${e.trim()}</li>`:"").join("")}</ul>`;else if("educacion"===e)t.className="item-block",t.innerHTML=`<div class="item-header"><h3>${a.titulo||""}</h3><p class="date">${a.fecha||""}</p></div><p class="education-institution">${a.institucion||""}</p>`;else if("habilidades"===e){t.className="skill-item",t.innerHTML=`<div><h3>${a.categoria||""}</h3><p>${a.lista||""}</p></div>`}};
    
    // CAMBIO: Esta función carga los datos de la plantilla
    const loadSampleData=e=>{
        lists.forEach(e=>{document.getElementById(`${e}-list`).innerHTML=""});
        const t=translations[e].sampleData;
        fields.forEach(e=>{const a=document.getElementById(e);a&&void 0!==t[e]&&(a.value=t[e])});
        lists.forEach(e=>{const a=e+"List";if(t[a]){const n=t[a].slice().reverse();n.forEach(t=>{addToList(e,t)})}});
        const a=document.getElementById("preview-photo");
        if(a) a.src="https://placehold.co/400x400/e2e8f0/e2e8f0?text=+";
    };

    const clearSavedData=()=>{
        // Ahora también borramos nuestra bandera
        localStorage.removeItem('cvEditorHasData');
        fields.forEach(e=>localStorage.removeItem(e));
        lists.forEach(e=>localStorage.removeItem(`${e}List`));
        localStorage.removeItem('userPhoto');
    };
    
    const applyTranslations=e=>{
        const t=translations[e].ui;document.querySelectorAll("[data-translate]").forEach(a=>{const n=a.getAttribute("data-translate");t[n]&&(a.textContent=t[n])});
        clearSavedData();
        loadSampleData(e);
        saveData();
        updatePreview();
    };

    // --- ¡NUEVA FUNCIÓN! ---
    // Esta función decide qué cargar al inicio.
    const loadDataOnStartup = () => {
        // Verificamos si nuestra bandera 'cvEditorHasData' existe.
        if (localStorage.getItem('cvEditorHasData')) {
            // Si existe, cargamos los datos del usuario.
            fields.forEach(field => {
                const input = document.getElementById(field);
                const savedValue = localStorage.getItem(field);
                if (input && savedValue !== null) {
                    input.value = savedValue;
                }
            });

            lists.forEach(listName => {
                const savedList = localStorage.getItem(`${listName}List`);
                if (savedList) {
                    const items = JSON.parse(savedList);
                    items.forEach(itemData => addToList(listName, itemData));
                }
            });
            
            const savedPhoto = localStorage.getItem("userPhoto");
            if (savedPhoto) {
                document.getElementById("preview-photo").src = savedPhoto;
            }
            
            updatePreview();
        } else {
            // Si no existe, es la primera visita. Cargamos tu plantilla.
            applyTranslations("en");
        }
    };

    const initializeApp=()=>{
        fields.forEach(e=>{const t=document.getElementById(e);t&&t.addEventListener("input",()=>{saveData(),updatePreview()})}),lists.forEach(e=>{const t=document.getElementById(`add-${e}`);t&&t.addEventListener("click",()=>{addToList(e),saveData(),updatePreview()})}),document.getElementById("photo-upload").addEventListener("change",e=>{const t=e.target.files[0];if(t){const a=new FileReader;a.onload=e=>{document.getElementById("preview-photo").src=e.target.result;saveData();},a.readAsDataURL(t)}}),document.getElementById("download-image").addEventListener("click",()=>{const e=document.getElementById("cv-preview-container"),t=document.getElementById("download-image");t.textContent="Generating...",t.disabled=!0,e.classList.add("export-mode"),html2canvas(e,{scale:3,useCORS:!0,logging:!1,windowWidth:e.scrollWidth,windowHeight:e.scrollHeight}).then(a=>{e.classList.remove("export-mode");const n=document.createElement("a");n.download=`cv-martin-mastrogiacomo-${document.getElementById("language-selector").value}.png`,n.href=a.toDataURL("image/png"),n.click(),t.textContent="Download Image",t.disabled=!1}).catch(a=>{console.error("Error generating image:",a),e.classList.remove("export-mode"),t.textContent="Download Image",t.disabled=!1})});const e=document.getElementById("language-selector");e.addEventListener("change",t=>{applyTranslations(t.target.value)});
        
        // --- CAMBIO CLAVE ---
        // Ya no llamamos a applyTranslations('en').
        // En su lugar, llamamos a nuestra nueva función de carga inteligente.
        loadDataOnStartup();
        
        // La animación se mantiene igual.
        animationFrameId&&cancelAnimationFrame(animationFrameId),initAnimation(),animate()
    };
    
    initializeApp();
});
</script>
