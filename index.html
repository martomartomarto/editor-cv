<script>
document.addEventListener('DOMContentLoaded', function() {
    // === TRADUCCIONES Y DATOS DE EJEMPLO (SIN CAMBIOS) ===
    const translations = {
        en: {
            ui: { dateOfBirth: "Date of birth", nationality: "Nationality", profile: "Executive Summary", employmentHistory: "Professional Experience", education: "Education", skills: "Skills" },
            sampleData: { nombre: 'Martín Mastrogiacomo', ubicacion: 'Buenos Aires, Argentina', email: 'martomastrogiacomo@gmail.com', telefono: '+549 11 5 890 7085', linkedin: 'https://www.linkedin.com/in/martin-mastrogiacomo/', fechaNacimiento: '09/02/1995', nacionalidad: 'Argentinean, Italian', perfil: `Results-driven Growth & Business Intelligence Specialist with a strong background in data analytics, digital marketing, and automation. Proven ability to leverage SQL, Tableau, Amazon Redshift, and A/B testing to drive growth, optimize user journeys, and enhance data-driven decision-making. Passionate about bridging the gap between marketing strategy and business intelligence to scale operations and maximize impact.`, experienciaList: [ {puesto:"Growth Lead, Ontop", fecha:"Apr 2025 — Present",descripcion:"Lead the overall growth strategy, integrating paid media, organic, and referral channels.\nDesign and optimize multi-channel marketing campaigns (Google Ads, LinkedIn Ads, Braze).\nAnalyze data (SQL, Tableau, Salesforce) to refine the ICP, segment audiences, and identify growth opportunities."}, {puesto:"Growth & BI Specialist, Ontop", fecha:"Apr 2023 — Apr 2025",descripcion:"Increased conversion rates by 10% through A/B testing on landing pages.\nBoosted retention rates by 15% by optimizing lifecycle marketing strategies.\nDeveloped predictive cohort analysis that reduced churn by 15%.\nAutomated Tableau dashboards, reducing decision-making time by 30%."}, {puesto:"BI Specialist, Flippin", fecha:"May 2022 — Dec 2022",descripcion:"Optimized investment decisions for real estate clients, increasing portfolio ROI by 12%.\nImplemented web scraping solutions that accelerated market trend analysis by 40%.\nDeveloped WhatsApp chatbots that improved lead generation by 35%."}, {puesto:"Managment Consultant, Accenture", fecha:"Aug 2021 — Apr 2022",descripcion:"Led Salesforce CPQ software implementation for enterprise clients.\nProvided pricing and sales strategy consulting, optimizing revenue operations."} ], educacionList: [ {titulo:"Data Analytics",institucion:"Digital House, Buenos Aires",fecha:"Apr 2020 — Sep 2020"}, {titulo:"Business Administration Degree",institucion:"Universidad de San Andres, Buenos Aires",fecha:"Jul 2013 — Jul 2017"}, {titulo:"Bilingual Bachelor",institucion:"Saint Gregory's College, Buenos Aires",fecha:"Feb 2010 — Dec 2012"} ], habilidadesList: [ {categoria:"Growth Strategy & Analytics",lista:"A/B Testing, Funnel Optimization, Cohort Analysis"}, {categoria:"Business Intelligence",lista:"Tableau, Power BI, Looker/Data Studio"}, {categoria:"Databases & SQL",lista:"Amazon Redshift, MySQL"}, {categoria:"Automation & Scripting",lista:"Google Sheets Scripts, Alteryx"} ] }
        },
        es: {
            ui: { dateOfBirth: "Fecha de Nacimiento", nationality: "Nacionalidad", profile: "Perfil", employmentHistory: "Experiencia Laboral", education: "Educación", skills: "Habilidades" },
            // Los datos de ejemplo en español ya no son necesarios para la lógica, pero los dejamos por si se usan en el futuro.
        }
    };

    // === ANIMACIÓN DE FONDO (SIN CAMBIOS) ===
    const headImageSrc = 'Subject.png';
    const heads = [];
    const numHeads = 15;
    const headSize = 90;
    const minSpeed = 0.5;
    const maxSpeed = 1.5;
    let animationFrameId;
    function initAnimation(){const container=document.getElementById("background-animation-container");if(!container)return;container.innerHTML="",heads.length=0;for(let e=0;e<numHeads;e++){const t=document.createElement("img");t.src=headImageSrc,t.className="rolling-head",t.style.width=`${headSize}px`,t.style.height="auto",container.appendChild(t),heads.push({element:t,x:Math.random()*window.innerWidth,y:Math.random()*window.innerHeight,vx:(Math.random()*(maxSpeed-minSpeed)+minSpeed)*(Math.random()<.5?1:-1),vy:(Math.random()*(maxSpeed-minSpeed)+minSpeed)*(Math.random()<.5?1:-1),rotation:360*Math.random(),rotationSpeed:2*(Math.random()-.5)})}}
    function animate(){heads.forEach(e=>{e.x+=e.vx,e.y+=e.vy,e.rotation+=e.rotationSpeed,(e.x<0||e.x>window.innerWidth-headSize)&&(e.vx*=-1),(e.y<0||e.y>window.innerHeight-headSize)&&(e.vy*=-1),e.element.style.transform=`translate(${e.x}px, ${e.y}px) rotate(${e.rotation}deg)`}),animationFrameId=requestAnimationFrame(animate)}

    // === DEFINICIÓN DE CAMPOS Y LISTAS (SIN CAMBIOS) ===
    const fields = ["nombre", "ubicacion", "email", "telefono", "linkedin", "fechaNacimiento", "nacionalidad", "perfil"];
    const lists = ["experiencia", "educacion", "habilidades"];

    // === FUNCIONES CRUD PARA ITEMS (SIN CAMBIOS) ===
    window.deleteItem=e=>{document.getElementById(`form-${e}`)?.remove(),saveData(),updatePreview()},window.moveItemUp=e=>{const t=document.getElementById(`form-${e}`);t?.previousElementSibling&&t.parentNode.insertBefore(t,t.previousElementSibling),saveData(),updatePreview()},window.moveItemDown=e=>{const t=document.getElementById(`form-${e}`);t?.nextElementSibling&&t.parentNode.insertBefore(t.nextElementSibling,t),saveData(),updatePreview()};

    // === LÓGICA DE GUARDADO Y VISTA PREVIA (CON PEQUEÑAS MEJORAS) ===
    const saveData = () => {
        fields.forEach(id => {
            const element = document.getElementById(id);
            if (element) localStorage.setItem(id, element.value);
        });
        lists.forEach(listName => {
            const items = Array.from(document.querySelectorAll(`#${listName}-list .item-form`)).map(form => {
                const itemData = {};
                form.querySelectorAll('input, textarea').forEach(input => {
                    itemData[input.dataset.key] = input.value;
                });
                return itemData;
            });
            localStorage.setItem(`${listName}List`, JSON.stringify(items));
        });
        const photoSrc = document.getElementById('preview-photo').src;
        if (photoSrc && !photoSrc.startsWith('https://placehold.co')) {
            localStorage.setItem('userPhoto', photoSrc);
        }
    };
    
    // ***NUEVA FUNCIÓN*** para aplicar estilo a la foto
    const updatePhotoStyle = (src) => {
        const photoElement = document.getElementById('preview-photo');
        if (!src || src.startsWith('https://placehold.co')) {
             photoElement.style.borderRadius = '8px';
             return;
        }
        const img = new Image();
        img.onload = () => {
            const ratio = img.naturalWidth / img.naturalHeight;
            // Si la imagen es casi cuadrada (entre 0.95 y 1.05 de ratio), la hacemos circular.
            if (ratio > 0.95 && ratio < 1.05) {
                photoElement.style.borderRadius = '50%';
            } else {
                photoElement.style.borderRadius = '8px';
            }
        };
        img.src = src;
    };

    const updatePreview = () => {
        document.getElementById('preview-nombre').textContent = document.getElementById('nombre').value;
        const contactInfo = [
            document.getElementById('ubicacion').value,
            document.getElementById('telefono').value,
            document.getElementById('email').value
        ];
        document.getElementById('preview-header-contact').textContent = contactInfo.filter(Boolean).join('  ·  ');
        
        const linkedinUrl = document.getElementById('linkedin').value;
        const linkedinContainer = document.getElementById('preview-linkedin-container');
        const linkedinIcon = '<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="currentColor" class="bi bi-linkedin" viewBox="0 0 16 16"><path d="M0 1.146C0 .513.526 0 1.175 0h13.65C15.474 0 16 .513 16 1.146v13.708c0 .633-.526 1.146-1.175 1.146H1.175C.526 16 0 15.487 0 14.854V1.146zm4.943 12.248V6.169H2.542v7.225h2.401zm-1.2-8.212c.837 0 1.358-.554 1.358-1.248-.015-.709-.52-1.248-1.342-1.248-.822 0-1.359.54-1.359 1.248 0 .694.521 1.248 1.327 1.248h.016zm4.908 8.212V9.359c0-.216.016-.432.08-.586.173-.431.568-.878 1.232-.878.869 0 1.216.662 1.216 1.634v3.865h2.401V9.25c0-2.22-1.184-3.252-2.764-3.252-1.325 0-1.845.723-2.165 1.193v.025h-.016a5.54 5.54 0 0 1 .016-.025V6.169h-2.4c.03.678 0 7.225 0 7.225h2.4z"/></svg>';
        if (linkedinUrl) {
            linkedinContainer.innerHTML = `<a href="${linkedinUrl}" target="_blank" rel="noopener noreferrer" class="text-gray-600 hover:text-blue-700 hover:underline flex items-center gap-1.5" style="font-size: 8.5pt;">${linkedinIcon} <span>${linkedinUrl.replace("https://www.","").replace("http://www.","").replace(/\/$/,"")}</span></a>`;
        } else {
            linkedinContainer.innerHTML = '';
        }

        document.getElementById('preview-fechaNacimiento').textContent = document.getElementById('fechaNacimiento').value;
        document.getElementById('preview-nacionalidad').textContent = document.getElementById('nacionalidad').value;
        document.getElementById('preview-perfil').textContent = document.getElementById('perfil').value;
        
        lists.forEach(listName => {
            const previewList = document.getElementById(`preview-${listName}-list`);
            previewList.innerHTML = '';
            const dataList = JSON.parse(localStorage.getItem(`${listName}List`)) || [];
            dataList.forEach(itemData => {
                const itemDiv = document.createElement('div');
                updateListPreview(listName, itemDiv, itemData);
                previewList.appendChild(itemDiv);
            });
        });
    };
    
    // === LÓGICA DE CREACIÓN DE FORMULARIOS Y VISTA PREVIA DE LISTAS (SIN CAMBIOS) ===
    const addToList = (listName, data = {}) => {
        const listContainer = document.getElementById(`${listName}-list`);
        const itemId = `${listName}-${Date.now()}-${Math.random()}`;
        const formDiv = document.createElement('div');
        formDiv.className = 'item-form p-3 border border-gray-200 rounded-md relative pr-10';
        formDiv.id = `form-${itemId}`;
        let formContent = '';
        if (listName === 'experiencia') { formContent = `<input type="text" data-key="puesto" placeholder="Position, Company" class="w-full p-1 mb-2 border rounded-md" value="${data.puesto || ''}"><input type="text" data-key="fecha" placeholder="Date" class="w-full p-1 mb-2 border rounded-md" value="${data.fecha || ''}"><textarea data-key="descripcion" placeholder="Description" class="w-full p-1 border rounded-md h-24">${data.descripcion || ''}</textarea>`; }  
        else if (listName === 'educacion') { formContent = `<input type="text" data-key="titulo" placeholder="Degree / Title" class="w-full p-1 mb-2 border rounded-md" value="${data.titulo || ''}"><input type="text" data-key="institucion" placeholder="Institution & Location" class="w-full p-1 mb-2 border rounded-md" value="${data.institucion || ''}"><input type="text" data-key="fecha" placeholder="Date" class="w-full p-1 border rounded-md" value="${data.fecha || ''}">`; }  
        else if (listName === 'habilidades') { formContent = `<input type="text" data-key="categoria" placeholder="Category" class="w-full p-1 mb-2 border rounded-md" value="${data.categoria || ''}"><textarea data-key="lista" placeholder="Skills" class="w-full p-1 border rounded-md h-16">${data.lista || ''}</textarea>`; }
        const controls = `<div class="item-controls"><button onclick="moveItemUp('${itemId}')" class="control-btn move-btn" title="Move up">&uarr;</button><button onclick="moveItemDown('${itemId}')" class="control-btn move-btn" title="Move down">&darr;</button><button onclick="deleteItem('${itemId}')" class="control-btn delete-btn" title="Delete">&times;</button></div>`;
        formDiv.innerHTML = formContent + controls;
        listContainer.prepend(formDiv); 
        formDiv.querySelectorAll('input, textarea').forEach(input => {
            input.addEventListener('input', () => { saveData(); updatePreview(); });
        });
    };
    
    const updateListPreview=(e,t,a)=>{if("experiencia"===e)t.className="item-block",t.innerHTML=`<div class="item-header"><h3>${a.puesto||""}</h3><p class="date">${a.fecha||""}</p></div><ul>${(a.descripcion||"").split("\n").map(e=>e.trim()?`<li>${e.trim()}</li>`:"").join("")}</ul>`;else if("educacion"===e)t.className="item-block",t.innerHTML=`<div class="item-header"><h3>${a.titulo||""}</h3><p class="date">${a.fecha||""}</p></div><p class="education-institution">${a.institucion||""}</p>`;else if("habilidades"===e){t.className="skill-item",t.innerHTML=`<div><h3>${a.categoria||""}</h3><p>${a.lista||""}</p></div>`}};

    // ***FUNCIÓN MODIFICADA***: Ahora solo cambia los textos de la UI.
    const applyTranslations = (lang) => {
        const uiTexts = translations[lang].ui;
        document.querySelectorAll('[data-translate]').forEach(element => {
            const key = element.getAttribute('data-translate');
            if (uiTexts[key]) {
                element.textContent = uiTexts[key];
            }
        });
    };

    // ***NUEVA FUNCIÓN***: Carga tus datos de ejemplo SÓLO si no hay datos del usuario.
    const loadInitialData = () => {
        // Comprueba si ya existe información del usuario. 'nombre' es un buen indicador.
        if (localStorage.getItem('nombre')) {
            // Cargar datos del usuario desde localStorage
            fields.forEach(id => {
                const element = document.getElementById(id);
                if (element) element.value = localStorage.getItem(id) || '';
            });
            lists.forEach(listName => {
                const dataList = JSON.parse(localStorage.getItem(`${listName}List`)) || [];
                // Revertimos para que al usar prepend() en addToList mantengan el orden correcto
                dataList.slice().reverse().forEach(itemData => {
                    addToList(listName, itemData);
                });
            });
            const userPhoto = localStorage.getItem('userPhoto');
            if (userPhoto) {
                document.getElementById('preview-photo').src = userPhoto;
                updatePhotoStyle(userPhoto); // Aplica estilo a la foto guardada
            }
        } else {
            // No hay datos del usuario, cargar tus datos de ejemplo por primera vez.
            const sample = translations.en.sampleData;
            fields.forEach(id => {
                const element = document.getElementById(id);
                if (element && sample[id] !== undefined) {
                    element.value = sample[id];
                }
            });
            lists.forEach(listName => {
                const listKey = `${listName}List`;
                if (sample[listKey]) {
                    sample[listKey].slice().reverse().forEach(itemData => {
                        addToList(listName, itemData);
                    });
                }
            });
            // Al final, guarda estos datos de ejemplo en localStorage para que persistan.
            saveData();
        }
        // Finalmente, actualiza la vista previa.
        updatePreview();
    };

    // === FUNCIÓN PRINCIPAL DE INICIALIZACIÓN (MODIFICADA) ===
    const initializeApp = () => {
        // Asignar eventos a los inputs de texto
        fields.forEach(id => {
            const element = document.getElementById(id);
            if (element) element.addEventListener('input', () => { saveData(); updatePreview(); });
        });

        // Asignar eventos a los botones de "añadir"
        lists.forEach(listName => {
            const addButton = document.getElementById(`add-${listName}`);
            if (addButton) addButton.addEventListener('click', () => { 
                addToList(listName);
                saveData(); 
                updatePreview(); 
            });
        });

        // Evento para subir la foto
        document.getElementById('photo-upload').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    const imgSrc = event.target.result;
                    document.getElementById('preview-photo').src = imgSrc;
                    localStorage.setItem('userPhoto', imgSrc);
                    updatePhotoStyle(imgSrc); // Llama a la nueva función para aplicar el estilo
                };
                reader.readAsDataURL(file);
            }
        });

        // Evento para el botón de descarga
        document.getElementById('download-image').addEventListener('click', () => {
            const cvContainer = document.getElementById('cv-preview-container');
            const button = document.getElementById('download-image');
            button.textContent = 'Generating...';
            button.disabled = true;

            cvContainer.classList.add('export-mode');

            html2canvas(cvContainer, { scale: 3, useCORS: true, logging: false, windowWidth: cvContainer.scrollWidth, windowHeight: cvContainer.scrollHeight })
                .then(canvas => {
                    cvContainer.classList.remove('export-mode');
                    const link = document.createElement('a');
                    link.download = `cv-martin-mastrogiacomo-${document.getElementById('language-selector').value}.png`;
                    link.href = canvas.toDataURL('image/png');
                    link.click();
                    button.textContent = 'Download Image';
                    button.disabled = false;
                })
                .catch(err => {
                    console.error('Error generating image:', err);
                    cvContainer.classList.remove('export-mode');
                    button.textContent = 'Download Image';
                    button.disabled = false;
                });
        });

        // ***LÓGICA DE INICIO MODIFICADA***
        const langSelector = document.getElementById('language-selector');
        langSelector.addEventListener('change', (e) => {
            applyTranslations(e.target.value); // Solo traduce
        });

        loadInitialData(); // Carga datos de usuario o de ejemplo
        applyTranslations(langSelector.value); // Aplica la traducción inicial
        
        // Iniciar animación
        if (animationFrameId) cancelAnimationFrame(animationFrameId);
        initAnimation();
        animate();
    };

    initializeApp();
});
</script>
